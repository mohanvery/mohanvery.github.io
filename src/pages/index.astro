---
import Layout from "../layouts/Layout.astro";
---

<Layout title="Welcome to Astro.">
    <main>
        <p id="jsonData">Test</p>
        <button id="visitorApiButton">Fetch Visitor Data</button>
    </main>
</Layout>

<script>
    var VisitorAPI = function (t: string, e: any, a: any) {
        var s = new XMLHttpRequest();
        (s.onreadystatechange = function () {
            var t;
            s.readyState === XMLHttpRequest.DONE &&
                (200 === (t = JSON.parse(s.responseText)).status
                    ? e(t.data)
                    : a(t.status, t.result));
        }),
            s.open("GET", "https://api.visitorapi.com/api/?pid=" + t),
            s.send(null);
    };

    function fetchVisitorData() {
        VisitorAPI(
            "x3xT1b2xqR07DtIyJtRp",
            function (data: any) {
                const Referrer = document.referrer;

                data.referrer = Referrer;

                const formatNavigatorObject = (obj: any) => {
                    const formattedObj: { [key: string]: any } = {};
                    for (let key in obj) {
                        if (typeof obj[key] === "object" && obj[key] !== null) {
                            formattedObj[key] = formatNavigatorObject(obj[key]);
                        } else {
                            formattedObj[key] = obj[key];
                        }
                    }
                    return formattedObj;
                };

                data.navigator = formatNavigatorObject(navigator);

                const formattedData = JSON.stringify(data, null, 2);
                const pTag = document.getElementById("jsonData");
                pTag!.innerHTML = `<pre>${formattedData}</pre>`;
            },
            function (errorCode: any, errorMessage: any) {
                console.log(errorCode, errorMessage);
            }
        );
    }

    document
        .getElementById("visitorApiButton")!
        .addEventListener("click", fetchVisitorData);
</script>
